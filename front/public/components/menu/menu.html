<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="/components/menu/menu.css">
<link rel="stylesheet" href="./menu.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

<div class="btn-expandir">
  <i class="bi bi-play-fill seta" id="btn-exp"></i>
</div>

<nav class="nav-lateral">
  <img src="../../assets/img/Logo 2.png" alt="" class="icone-logo">
  <ul style="padding-left: 0px;">

    <li class="item-menu ativo">
      <a href="/">
        <span class="icone"><i class="bi bi-house-door-fill"></i></span>
        <span class="txt-link">Home</span>
      </a>
    </li>

    <li class="item-menu">
      <a href="/plantas">
        <span class="icone"><i class="bi bi-tree-fill"></i></span>
        <span class="txt-link">Plantas</span>
      </a>
    </li>

    <li class="item-menu">
      <a href="#" id="linkPerfil">
        <span class="icone"><i class="bi bi-person-fill"></i></span>
        <span class="txt-link">Perfil</span>
      </a>
    </li>

    <li class="item-menu">
      <a href="#" id="Outros">
        <span class="icone"><i class="bi bi-plus-circle-fill"></i></span>
        <span class="txt-link">Outros</span>
        <span class="iconesize" style="margin-left: 70px;"><i class="bi bi-arrow-down-short"></i></span>
      </a>
    </li>

    <div class="dropdown">
      <li class="item-menu">
        <a href="/politicaDePrivacidade" id="politicasEPrivacidade">
          <span class="icone"><i class="bi bi-shield-lock-fill"></i></span>
          <span class="txt-link">Políticas e <br> Privacidade</span>
          <span class="iconesize" style="margin-left: 70px;"></span>
        </a>
      </li>

      <li class="item-menu">
        <a href="/termosDeServico" id="termosDeServico">
          <span class="icone"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="txt-link">Termos de <br> Serviço</span>
          <span class="iconesize" style="margin-left: 70px;"></span>
        </a>
      </li>

    </div>
  </ul>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
  integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>

<script>
  const menuItem = document.querySelectorAll('.item-menu');
  const btnExp = document.querySelector('#btn-exp');
  const menuSide = document.querySelector('.nav-lateral');
  const btnExpandir = document.querySelector('.btn-expandir');
  const outros = document.getElementById("Outros");
  const dropdown = document.querySelector(".dropdown");

  // Expande/recolhe o menu
  btnExp.addEventListener('click', function () {
    menuSide.classList.toggle('expandir');
    btnExpandir.classList.toggle('expandir');
  });

  // Define automaticamente o item ativo com base na URL
  const currentPath = window.location.pathname;

  menuItem.forEach(item => {
    const link = item.querySelector('a');
    if (link && link.getAttribute('href') === currentPath) {
      item.classList.add('ativo');
    } else {
      item.classList.remove('ativo');
    }
  });

  // Redireciona Perfil dependendo do login
  document.getElementById("linkPerfil").addEventListener("click", async function (e) {
    e.preventDefault(); // evita seguir o href="#"

    const userStr = localStorage.getItem("user");

    if (!userStr) {
      // Não logado → vai para login
      window.location.href = "/login";
      return;
    }

    // Usuário logado → abre o perfil como "modal" (carrega o fragmento de perfil.html)
    try {
      const resp = await fetch("/page/perfil/perfil.html");
      if (!resp.ok) throw new Error("Falha ao carregar perfil");
      const htmlText = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, "text/html");

      // procura o container principal da página de perfil
      const perfilNode = doc.querySelector(".P-esconder");
      if (!perfilNode) throw new Error("Conteúdo de perfil não encontrado");

      // cria overlay para mostrar o perfil como modal
      const overlay = document.createElement("div");
      overlay.id = "perfil-overlay-wrapper";
      Object.assign(overlay.style, {
        position: "fixed",
        inset: "0",
        background: "rgba(0,0,0,0.6)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        zIndex: "99999",
        overflowY: "auto",
        padding: "20px",
      });

      // clona o conteúdo do perfil (removendo comportamento "position: fixed" se houver)
      const cloned = perfilNode.cloneNode(true);
      cloned.style.position = "relative";
      cloned.style.maxHeight = "90vh";
      cloned.style.overflow = "auto";
      cloned.style.background = "transparent";

      // adiciona um botão de fechar no canto superior direito
      const closeBtn = document.createElement("button");
      closeBtn.setAttribute("aria-label", "Fechar perfil");
      closeBtn.innerHTML = "✕";
      Object.assign(closeBtn.style, {
        position: "fixed",
        top: "18px",
        right: "18px",
        zIndex: "100000",
        fontSize: "24px",
        background: "transparent",
        border: "none",
        color: "#fff",
        cursor: "pointer",
      });

      // anexa elementos
      overlay.appendChild(cloned);
      overlay.appendChild(closeBtn);
      document.body.appendChild(overlay);

      // Fecha o menu lateral caso esteja aberto (quando o perfil é exibido como modal)
      if (menuSide && menuSide.classList.contains('expandir')) {
        menuSide.classList.remove('expandir');
      }
      if (btnExpandir && btnExpandir.classList.contains('expandir')) {
        btnExpandir.classList.remove('expandir');
      }

      // inicializa os campos do perfil (já que o script interno de perfil.html pode não executar ao inserir via fetch)
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const token = localStorage.getItem('token');

      const idSpan = overlay.querySelector('#userId');
      if (idSpan) idSpan.textContent = user.id || 'Não informado';
      const emailSpan = overlay.querySelector('#userEmail');
      if (emailSpan) emailSpan.textContent = user.email || 'Não informado';
      const nomeSpan = overlay.querySelector('#userNome');
      if (nomeSpan) nomeSpan.textContent = user.nome || 'Não informado';
      const telefoneSpan = overlay.querySelector('#userTelefone');
      if (telefoneSpan) telefoneSpan.textContent = user.telefone || 'Não informado';

      // logout dentro do modal
      const logoutBtn = overlay.querySelector('#logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login';
        });
      }

      // fechar ao clicar no botão
      closeBtn.addEventListener('click', () => {
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      });

      // fechar ao clicar fora do conteúdo (clicando no overlay)
      overlay.addEventListener('click', (ev) => {
        if (ev.target === overlay) {
          if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
        }
      });

    } catch (err) {
      console.error('Erro ao abrir perfil:', err);
      alert('Erro ao abrir perfil: ' + (err.message || err));
    }
  });

  outros.addEventListener("click", function (e) {
    e.preventDefault();
    dropdown.classList.toggle("show");
  });
</script>